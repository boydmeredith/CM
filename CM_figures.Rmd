---
title: "CM mvpa analysis"
output: html_document
---
This document will contain the figures we publish in our countermeasures manuscript.

First off, we'll need to load the packages we plan to use.
```{r load_packages}
require(plyr) #allows us to summarize data along dimensions we care about
library(ggplot2) #ggplot! our favorite plotting tool
require(gridExtra) #allows arrangement of figures in grids
```

Then, we'll setup some variables that we'll use to control how our plots look.

```{r}
#the color blind compatible palette we'll use for our colors
cbPalette <- c( "#56B4E9","#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#999999", "#E69F00")

#a dashed horizontal line to represent chance for binary classifiers
fiftyline=stat_abline(intercept=.5,slope=0,linetype="dashed",color='black',size=1)

#specify font size and face for axis labels and title
plotformat=theme(title= element_text(face="bold",size=15),axis.title = element_text(face="bold",size=14),axis.text=element_text(size=13))
```

Now that we've got that setup, we'll grab the data that we plan to use a bunch from our 'results_sheets' directory.

```{r load_data, echo=FALSE}
dir = "~/cm/Scripts/"
behav_dat_file = sprintf("%s/results_sheets/cm_behav_to_r.csv",dir)
mvpa_dat_file = sprintf("%s/results_sheets/aucSummaryToR__exex_excm_cmcm_hitvcr.csv",dir)

behav_df = read.csv(behav_dat_file, header=T)
mvpa_df = read.csv(mvpa_dat_file, header=T)
```

#Figure 1 #Figure 2 #Figure 3 #Figure 4
#Figure 5. Accuracy, confidence, d'
##A. AUC by Confidence EX>CM late, EX>EX late, EX>CM tr 3
We'll try looking at:
- accuracy by confidence
- accuracy by confidence bin
```{r load_this_mvpa_dat}
mvpa_extocm_tr3_file = sprintf("%s/results_sheets/xvals2_runsrepotred_conds_hitVcr_trTe1_1_1_1_2_2_2_2_trW0__0__1__0__0__0_roiSEPT09_MVPA_MASK_resliced4mm.csv",dir) 
mvpa_extocm_late_file = sprintf("%s/results_sheets/xvals2_runsrepotred_conds_hitVcr_trTe1_1_1_1_2_2_2_2_trWtr0___________0________0.33________0.34________0.33___________0_te0___________0________0.33________0.34________0.33___________0_roiSEPT09_MVPA_MASK_resliced4mm.csv",dir) 
mvpa_ex_late_file = sprintf("%s/results_sheets/xvals_runsrepotred_conds_hitVcr_trTe1_2_3_4_0_0_0_0_trW0___________0________0.33________0.34________0.33___________0_roiSEPT09_MVPA_MASK_resliced4mm.csv",dir) 

mvpa_extocm_tr3_df = read.csv(mvpa_extocm_tr3_file, header=T)
mvpa_extocm_late_df = read.csv(mvpa_extocm_late_file, header=T)
mvpa_ex_late_df = read.csv(mvpa_ex_late_file, header=T)

mvpa_extocm_tr3_df$name = 'extocm_tr3'
mvpa_extocm_late_df$name = 'extocm_late'
mvpa_ex_late_df$name = 'extoex_late'

confbyacc_df = rbind(mvpa_extocm_tr3_df,mvpa_extocm_late_df,mvpa_ex_late_df)
```

```{r plot accuracy by confidence}
qplot(abs(actsVec-.5),correctsVec,data=confbyacc_df,group=name,color=name,geom='smooth',size=.5)+fiftyline+theme_bw()+plotformat+labs(y=expression("p(classifier correct)"),x=expression("confidence = |p(hit)-.5|"),title="Classifier Accuracy by Confidence")+geom_point(alpha=.05,position=position_jitter(width=0,height=.1))

```


```{r build confidence bins, cache = T}
confbyacc_sorted_df = confbyacc_df[with(confbyacc_df, order(name, subs, -abs(actsVec-.5))),]
acc = numeric(0)
subj_num = integer(0)
mvpa_name = character(0)
bin_name = character(0)
bin_num=numeric(0)
  
bins =seq(1,.05,-.05)

names = unique(confbyacc_sorted_df$name)
x=0
for (iname in 1:length(names)){
  this_name = names[iname]
  for (jsub in unique(confbyacc_sorted_df$subs)){
    ntrials = length(with(confbyacc_sorted_df, confbyacc_sorted_df[subs==jsub & name==this_name, "subs"]))
    for (acc_bin in seq(1,20)){
      x=x+1
      included_trial_inds = 1:ceiling(ntrials * bins[acc_bin])
      mvpa_name[x]=this_name
      subj_num[x]=jsub
      bin_name[x] = sprintf('top %s%%',bins[acc_bin]*100)
      bin_num[x]=acc_bin
      acc[x] = with(subset(confbyacc_sorted_df,name==this_name & subs==jsub),mean(correctsVec[included_trial_inds]))
    }
  }
}

weirdlybinnedaccconf_df = data.frame(sub = subj_num,name = mvpa_name, acc=acc, bin_name=bin_name, bin_num=bin_num)

weirdlybinnedaccconf_df$bin_name = factor(weirdlybinnedaccconf_df$bin_name,
                                      levels=(weirdlybinnedaccconf_df$bin_name[1:20]))

```

```{r plot weird accuracy by confidence}

confacc_ag<-ddply(weirdlybinnedaccconf_df,c("bin_num","name"),summarise,N=length(acc),mean_acc=mean(acc),sd_acc = sd(acc), sem_acc=sd_acc/sqrt(N), min_acc = mean_acc-sem_acc, max_acc = mean_acc+sem_acc)

model<- lm(acc~bin_num*name,data=weirdlybinnedaccconf_df)
grid <- with(weirdlybinnedaccconf_df, expand.grid(
  name = levels(name),
  bin_num = bin_num
))
grid$acc<-stats::predict(model,newdata=grid)

confacc_plt<-ggplot(weirdlybinnedaccconf_df,aes(x=bin_num,y=acc,group=name,color=name))+theme_bw()+theme(axis.text.x  = element_text(angle=45, vjust=0.5, size=16))+plotformat+labs(x='percentile confidence bin',y=expression("p(classifier correct)"),title="Classifier accuracy by confidence")

confacc_plt+geom_pointrange(data=confacc_ag,aes(x=bin_num,y=mean_acc,ymin=min_acc,ymax=max_acc),size=.85)+  geom_line(data=grid,size=.75) + scale_x_continuous(labels=weirdlybinnedaccconf_df$bin_name[seq(1,20,2)],breaks=seq(1,20,2))+scale_color_discrete(breaks=c("extocm_late","extocm_tr3","extoex_late"),labels=c("EX>CM, late TRs", "EX>CM, 3rd TR","EX, 4fold, late TRs"),name='Classifier')

confacc_plt+geom_pointrange(data=confacc_ag,aes(x=bin_num,y=mean_acc,ymin=min_acc,ymax=max_acc),size=.85)+  geom_line(aes(x=bin_num,y=mean_acc),data=confacc_ag,size=.75) + scale_x_continuous(labels=weirdlybinnedaccconf_df$bin_name[seq(1,20,2)],breaks=seq(1,20,2))+scale_color_discrete(breaks=c("extocm_late","extocm_tr3","extoex_late"),labels=c("EX>CM, late TRs", "EX>CM, 3rd TR","EX, 4fold, late TRs"),name='Classifier')

mvpa_extocm_late_df = read.csv(mvpa_extocm_late_file, header=T)
mvpa_ex_late_df = read.csv(mvpa_ex_late_file, header=T)
```

##B. EX>CM TR3 AUC by CM d'
```{r cm d prime vs ex>cm tr 3}
excmtr3 = mvpa_df[mvpa_df$tr==3 & mvpa_df$train_test=="EX>CM",]
excmtr3$cm_d = behav_df$cm_d
excmtr3$ex_d = behav_df$ex_d
#are these correlated with cm d'
with(excmtr3,cor.test(auc,cm_d))
#what about with ex d'?
with(excmtr3,cor.test(auc,ex_d))
#plot them
ggplot(excmtr3,aes(y=auc,x=cm_d))+geom_point(size=2.5)+geom_smooth(method="lm",fullrange=T,formula=y~log(x+1))+theme_bw()+plotformat+labs(y="EX>CM Classifier Performance (AUC)",x="CM Memory Performance (d')")
#are ex and cm d' correlated?
with(excmtr3,cor.test(cm_d,ex_d))
ggplot(excmtr3,aes(y=auc,x=cm_d))+geom_point(size=2.5)+geom_smooth(method="lm")+theme_bw()+plotformat+labs(y="EX>CM Classifier Performance (AUC)",x="CM Memory Performance (d')")
```

#Figure 6. CM>CM and CM>EX Violins!
```{r make late trs df}
train_test_levels = c('EX,4fold','CM,4fold','EX>CM','CM>EX')
latetrs_mvpa_df = subset(mvpa_df,tr=='late' & train_test %in% train_test_levels)
latetrs_mvpa_df$train_test=factor(latetrs_mvpa_df$train_test,levels=train_test_levels)
```

```{r plot train_cm violins}
ggplot(subset(latetrs_mvpa_df,train_test %in% c('CM,4fold','CM>EX')), aes(x=train_test, y=auc))+geom_violin(aes(fill=train_test),trim=F,alpha=.6)+geom_point(aes(color=sub),show_guide=F)+geom_line(aes(color=sub, group=sub),show_guide=F)+theme_bw()+fiftyline+labs(y="Classifier Performance (AUC)", x="Testing Data (task)", title="Classifier Trained on CM")+theme(axis.ticks=element_blank(),axis.text.x=element_blank())+scale_fill_manual(values=cbPalette[c(5,3)],name="Testing Data",breaks=c("CM,4fold","CM>EX"),labels=c("CM (cross-validated)","EX"))+plotformat+geom_point(stat='summary',fun.y='mean')

```

```{r plot train_ex violins }
ggplot(subset(latetrs_mvpa_df,train_test %in% c('EX,4fold','EX>CM')), aes(x=train_test, y=auc))+geom_violin(aes(fill=train_test),trim=F,alpha=.6)+geom_point(aes(color=sub),show_guide=F)+geom_line(aes(color=sub, group=sub),show_guide=F)+theme_bw()+fiftyline+labs(y="Classifier Performance (AUC)", x="Testing Data (task)", title="Classifier Trained on CM")+theme(axis.ticks=element_blank(),axis.text.x=element_blank())+scale_fill_manual(values=cbPalette,name="Testing Data",breaks=c("EX,4fold","EX>CM"),labels=c("EX (cross-validated)","CM"))+plotformat+geom_point(stat='summary',fun.y='mean')
```

We'll try it with the old data

```{r make plots for data trained within ex}
df_withinS = read.csv("/Volumes/Tyler_Drive1/CM_mvpa_results/aucSummary_exex_cmcm_hitvcr_macarthur_101014.csv", header = T)
```

```{r violin within subs}
df2 = subset(df_withinS,tr=="late")
df2$trte=factor(df2$trte,levels=c('EX>EX','EX>CM'))

c<-cor.test(df2$auc[df2$trte=="EX>EX"],df2$auc[df2$trte=="EX>CM"],method="pearson")

h2<-ggplot(df2, aes(x=trte,y=auc, fill=trte))+geom_violin(trim=F,alpha=.6)+fiftyline

h2<-h2+geom_line(aes(group=df_h$subj),color=df_h$subj,linetype="longdash")

h2<-h2+geom_point(stat='summary',fun.y='mean')

h2+theme_bw()+labs(y="Classifier Performance (AUC)", x="Testing Data (task)", title="SEPT 09 Mask Within S")+scale_x_discrete(breaks=NULL)+theme(axis.ticks=element_blank(),axis.text.x=element_blank())+scale_fill_manual(values=cbPalette,name="Testing Data",breaks=c("EX>EX","EX>CM"),labels=c("Explicit","Countermeasures"))+plotformat+ylim(0.1, 1)

```



#Figure 7. Tr Sweep!

First, load the data from our special TR sweep results sheet.
```{r load tr sweep df}
trsweepexcm_file = sprintf('%s/results_sheets/aucSummary__EXCMTrSweep.csv',dir)
trsweepexcm_df = read.csv(trsweepexcm_file,header=T)
trsweep_df=trsweepexcm_df
```

Then, get the mean, and sem of auc in this data grouped by trained and testing trs, and whether or not the data is scrambled.

```{r summarize_tr_swweep_df}
trsweep_dfS<-ddply(trsweep_df,c("tr_train","tr_test","tr_te","scrambled"),summarise,N=length(auc),mean_auc=mean(auc),sd_auc = sd(auc), sem_auc=sd_auc/sqrt(N))
```

Now, we'll check for significance. Whether our results are significant should depend on our choice of `m` (where we want $p \le \alpha/m)

```{r tr_sweep_significance}
#train tr 3, test tr 3 above chance
with(subset(trsweep_df, tr_train==3 & tr_test==3),t.test(auc[scrambled==FALSE],auc[scrambled==TRUE]))
#train tr 4, test tr 3 above chance
with(subset(trsweep_df, tr_train==4 & tr_test==3),t.test(auc[scrambled==FALSE],auc[scrambled==TRUE]))
#train tr 3, test tr 5 below chance
with(subset(trsweep_df, tr_train==3 & tr_test==5),t.test(auc[scrambled==FALSE],auc[scrambled==TRUE]))
#train tr 4, test tr 5 shows no diff from chance
with(subset(trsweep_df, tr_train==4 & tr_test==5),t.test(auc[scrambled==FALSE],auc[scrambled==TRUE]))
```

Let's visualize the result, using our friend ggplot.

```{r plot tr_sweep_fig}
tr_sweep_fig <- ggplot(trsweep_dfS, aes(x=as.numeric(tr_test), y=mean_auc,color=interaction(scrambled,factor(tr_train)),fill=factor(tr_train),alpha=.5))+  geom_ribbon(aes(ymin=mean_auc-sem_auc, ymax=mean_auc+sem_auc))+geom_line(linetype='dashed')+plotformat+fiftyline+ylim(.4,.7)+theme_bw()
tr_sweep_fig
```



Let's depict this as a visualization.

#Figure 8: ROIS
##EX>CM
```{r look at EX>CM in rois}
roi_dat_file = sprintf('%s/results_sheets/aucSummary__EXCM_masked.csv',dir)
roi_df = read.csv(roi_dat_file,header=T)
```

```{r make some plots}
roi_dfS<-ddply(roi_df,c("mask","tr"),summarise,N=length(auc),mean_auc=mean(auc),sd_auc = sd(auc), sem_auc=sd_auc/sqrt(N), min_auc = mean_auc-sem_auc, max_auc = mean_auc+sem_auc)

qplot(tr,auc,data=roi_df,geom='bar',stat='summary',fun.y='mean',position=position_dodge(.9),fill=mask,group=mask)+geom_errorbar(data=roi_dfS,aes(x=tr,y=mean_auc,ymin=min_auc, ymax=max_auc),position=position_dodge(.9))+fiftyline+labs(title='EX>CM roi aucs')

ggplot(roi_dfS,aes(x=tr,y=mean_auc))+geom_pointrange(position = position_dodge(.3), aes(color=mask, group=mask,ymin=min_auc,ymax=max_auc),size=1.15)+fiftyline+labs(title='EX>CM roi aucs')+theme_bw()+plotformat

```


